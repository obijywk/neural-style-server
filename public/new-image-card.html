<link rel="import" href="bower_components/polymer/polymer.html">

<link rel="import" href="bower_components/iron-image/iron-image.html">
<link rel="import" href="bower_components/paper-button/paper-button.html">
<link rel="import" href="bower_components/paper-card/paper-card.html">
<link rel="import" href="bower_components/paper-progress/paper-progress.html">

<link rel="import" href="render-settings.html">

<dom-module id="new-image-card">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .create-new-image-content {
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .image-picker {
        margin: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .input-image {
        width: 192px;
        height: 192px;
        border: 1px solid #666;
      }

      .action-buttons {
        display: flex;
        flex-direction: row;
      }

      paper-progress {
        width: 100%;
        margin: 8px;
      }
    </style>
    <paper-card heading="Create New Image">
      <div class="card-content create-new-image-content">
        <div class="image-picker">
          <iron-image id="contentImagePreview" class="input-image" sizing="contain"></iron-image>
          <input
             type="file"
             id="contentFileInput"
             class="hidden"
             accept="image/*"
             on-change="contentFileChanged_">
          <paper-button on-tap="chooseContentImage_">Choose Content Image</paper-button>
        </div>
        <div class="image-picker">
          <iron-image id="styleImagePreview" class="input-image" sizing="contain"></iron-image>
          <input
             type="file"
             multiple="true"
             id="styleFileInput"
             class="hidden"
             accept="image/*"
             on-change="styleFileChanged_">
          <paper-button on-tap="chooseStyleImage_">Choose Style Image</paper-button>
        </div>
        <render-settings id="renderSettings"></render-settings>
      </div>
      <div class="card-actions">
        <div class="action-buttons">
          <paper-button
             disabled="{{ startButtonDisabled_ }}"
             on-tap="start_">
            Start
          </paper-button>
          <paper-button
             disabled="{{ uploading_ }}"
             on-tap="reset_">
            Reset
          </paper-button>
        </div>
        <paper-progress id="uploadProgress" class="hidden" value="{{ uploadProgress_ }}"></paper-progress>
      </div>
    </paper-card>
  </template>
  <script>
    (function() {
      'use strict';
      Polymer({
        is: 'new-image-card',
        properties: {
          id_: {
            type: String,
            value: null,
          },
          contentFiles_: {
            type: Array,
            value: function() { return []; },
          },
          styleFiles_: {
            type: Array,
            value: function() { return []; },
          },
          uploading_: {
            type: Boolean,
            value: false,
          },
          contentUploadProgress_: {
            type: Number,
            value: 0,
          },
          styleUploadProgress_: {
            type: Number,
            value: 0,
          },
          contentUploadDone_: {
            type: Boolean,
            value: false,
          },
          styleUploadDone_: {
            type: Boolean,
            value: false,
          },
          uploadProgress_: {
            type: Number,
            computed: 'computeUploadProgress_(contentUploadProgress_, styleUploadProgress_, contentFiles_, styleFiles_)',
          },
          startButtonDisabled_: {
            type: Boolean,
            computed: 'computeStartButtonDisabled_(contentFiles_, styleFiles_, uploading_)',
          },
        },
        computeUploadProgress_: function(contentUploadProgress, styleUploadProgress, contentFiles, styleFiles) {
          var progress;
          if (contentFiles.length + styleFiles.length == 0) {
            progress = 0;
          } else {
            progress = 100 * (contentUploadProgress + styleUploadProgress) / (contentFiles.length + styleFiles.length);
          }
          return progress;
        },
        computeStartButtonDisabled_: function(contentFiles, styleFiles, uploading) {
          return !contentFiles.length || !styleFiles.length || uploading;
        },
        finishUpload_: function() {
          this.set('uploading_', false);
          this.$.uploadProgress.classList.add('hidden');
          this.set('id_', null);
          this.set('contentUploadProgress_', 0);
          this.set('styleUploadProgress_', 0);
          this.set('contentUploadDone_', false);
          this.set('styleUploadDone_', false);
        },
        reset_: function() {
          this.finishUpload_();
          this.$.renderSettings.reset();
          this.set('contentFiles_', []);
          this.$.contentImagePreview.src = '';
          this.set('styleFiles_', []);
          this.$.styleImagePreview.src = '';
        },
        chooseContentImage_: function() {
          this.$.contentFileInput.click();
        },
        chooseStyleImage_: function() {
          this.$.styleFileInput.click();
        },
        contentFileChanged_: function() {
          this.handleFileInput_('contentFiles_', this.$.contentFileInput.files, this.$.contentImagePreview);
        },
        styleFileChanged_: function() {
          this.handleFileInput_('styleFiles_', this.$.styleFileInput.files, this.$.styleImagePreview);
        },
        handleFileInput_: function(fileProperty, files, imageElement) {
          if (files.length == 0) return;
          this.set(fileProperty, []);
          for (var i = 0; i < files.length; i++) {
            if (!files[i].type.startsWith('image/')) {
              return;
            }
          }
          this.set(fileProperty, files);
          var reader = new FileReader();
          reader.onload = function(event) {
            imageElement.src = event.target.result;
          };
          reader.readAsDataURL(files[0]);
        },
        start_: function() {
          this.set('uploading_', true);
          this.$.uploadProgress.classList.remove('hidden');
          this.set('id_', Math.round(Math.random() * Math.pow(10, 16)));
          this.set('contentUploadProgress_', 0);
          this.set('styleUploadProgress_', 0);
          _.each(this.contentFiles_, function(file, i, arr) {
            this.uploadImage_(file, i, arr.length, 'content');
          }, this);
          _.each(this.styleFiles_, function(file, i, arr) {
            this.uploadImage_(file, i, arr.length, 'style');
          }, this);
        },
        uploadImage_: function(file, index, fileCount, purpose) {
          var xhr = new XMLHttpRequest();
          xhr.addEventListener('load', function(event) {
            this.set(purpose + 'UploadProgress_', this[purpose + 'UploadProgress_'] + 1);
            if (this[purpose + 'UploadProgress_'] == fileCount) this.set(purpose + 'UploadDone_', true);
            if (this.contentUploadDone_ && this.styleUploadDone_) {
              this.render_();
              this.finishUpload_();
            }
          }.bind(this), false);
          xhr.open('POST', '/upload/' + this.id_ + '/' + purpose + '/' + index);
          xhr.setRequestHeader('Content-Type', 'application/octet-stream');
          var reader = new FileReader();
          reader.onload = function(event) {
            xhr.send(event.target.result);
          };
          reader.readAsArrayBuffer(file);
        },
        render_: function() {
          var xhr = new XMLHttpRequest();
          xhr.open('POST', '/render/' + this.id_);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.send(JSON.stringify(this.$.renderSettings.settings));
        },
        setSettings: function(settings) {
          this.set('$.renderSettings.settings', settings);
        },
        setContentImage: function(imageUrl) {
          this.setImage_(imageUrl, 'contentFiles_', this.$.contentImagePreview);
        },
        setStyleImage: function(imageUrl) {
          this.setImage_(imageUrl, 'styleFiles_', this.$.styleImagePreview);
        },
        setImage_: function(imageUrl, fileProperty, imageElement) {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', imageUrl);
          xhr.responseType = 'blob';
          xhr.onload = function() {
            var blob = xhr.response;
            this.set(fileProperty, [blob]);
            var reader = new FileReader();
            reader.onload = function(event) {
              imageElement.src = event.target.result;
            };
            reader.readAsDataURL(blob);
          }.bind(this);
          xhr.send();
        },
      });
    })();
  </script>
</dom-module>
